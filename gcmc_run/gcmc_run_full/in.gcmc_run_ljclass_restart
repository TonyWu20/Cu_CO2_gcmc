# ========================================================
# LAMMPS Input Script for GCMC Simulation of CO2 Adsorption
# in Cu_cav@C Core-Shell Structure with ReaxFF Force Field
# ========================================================


variable        Cu_radius equal 175     # Angstrom (2.5 nm)
# ========== Read Structure ==========
read_restart      restart_175.*.lammps 
# ========== Atom Type Definitions ==========
# Type 1: Cu (from core)
# Type 2: C  (from carbon shell)
# Type 3: C  (from CO2 molecule)
# Type 4: O  (from CO2 molecule)

# Define CO2 molecule template
molecule        co2mol CO2.mol  toff 2 # Create this file with CO2 coordinates

# ========== Force Field ==========

pair_style      hybrid/overlay eam lj/class2/coul/long 12.0 lj/class2 10.0
pair_modify     mix geometric
kspace_style    pppm 1.0e-4 
kspace_modify   gewald 1.0e-4
pair_coeff      1 1 eam Cu_u3.eam
pair_coeff      2 2 lj/class2 0.07 3.33
# C(CO2)-C(CO2): 12-6: ε=0.0559 kcal/mol, σ=3.74 Å → 9-6: ε=0.0559, σ=3.667 Å
pair_coeff      3 3 lj/class2/coul/long 0.0559 3.667  # kcal/mol, Å

# O(CO2)-O(CO2): 12-6: ε=0.159 kcal/mol, σ=3.05 Å → 9-6: ε=0.159, σ=2.991 Å
pair_coeff      4 4 lj/class2/coul/long 0.159 2.991   # kcal/mol, Å

# ----- Cu-CO2 (literature values, already in kcal/mol) -----
# Cu-C(CO2): ε=0.042 kcal/mol, σ=3.15 Å → 9-6: ε=0.042, σ=3.089 Å
pair_coeff      1 3 lj/class2/coul/long 0.042 3.089  # kcal/mol, Å

# Cu-O(CO2): ε=0.031 kcal/mol, σ=3.28 Å → 9-6: ε=0.031, σ=3.217 Å
pair_coeff      1 4 lj/class2/coul/long 0.031 3.217  # kcal/mol, Å

# ----- Cross terms -----
# C(graphite)-C(CO2): ε=√(0.07×0.0559)=0.0626 kcal/mol, σ=(3.334+3.667)/2=3.5005 Å
pair_coeff      2 3 lj/class2/coul/long 0.0626 3.501  # kcal/mol, Å

# C(graphite)-O(CO2): ε=√(0.07×0.159)=0.1055 kcal/mol, σ=(3.334+2.991)/2=3.1625 Å
pair_coeff      2 4 lj/class2/coul/long 0.1055 3.163  # kcal/mol, Å

# C(CO2)-O(CO2): ε=√(0.0559×0.159)=0.094 kcal/mol, σ=(3.667+2.991)/2=3.329 Å
pair_coeff      3 4 lj/class2/coul/long 0.094 3.329  # kcal/mol, Å

# Cu-C(graphite): ε=0.02 kcal/mol, σ=3.35 Å → 9-6: ε=0.02, σ=3.286 Å
pair_coeff      1 2 lj/class2 0.02 3.286  # kcal/mol, Å


# ========== Define Regions ==========
# Region for GCMC insertion (gap between Cu core and carbon shell)
variable        gap equal 82.2           # Angstrom (8.22 nm)
variable        outer_radius equal ${Cu_radius}+${gap}
variable        cu_core_outer equal ${Cu_radius}-1.5
variable        center equal lx/2

# Define spherical shell region for CO2 insertion
region          cu_core_outward     sphere ${center} ${center} ${center} ${cu_core_outer} side out
region          carbon_shell sphere ${center} ${center} ${center} ${outer_radius} side in
region          gap_region  intersect 2 cu_core_outward carbon_shell
variable        cell_length equal lx
region          cell  block 0.0 ${cell_length} 0.0 ${cell_length} 0.0 ${cell_length}
region          out_of_cu sphere ${center} ${center} ${center} ${cu_core_outer} side out
region          gcmc_region intersect 2 out_of_cu cell

# Region to constrain Cu core (optional, to prevent drift)
region          cu_core sphere ${center} ${center} ${center} ${Cu_radius} side in
group           cu_core_group region cu_core

thermo          100
thermo_style    custom step cpu cpuremain temp press density vol atoms etotal pe ke 
thermo_modify   lost warn flush yes
timestep        0.1 # 0.1 fs

# ========== GCMC Setup for CO2 Adsorption ==========


# GCMC parameters
variable        T equal 298.0     # K
variable        P equal 10.0          # bar
variable        kT equal 0.001987*${T} # kcal/mol
variable        mu0 equal -416.71462715         # μ at 1 bar, 298 K
variable        mu  equal ${mu0}+${kT}*ln(${P})           # Chemical potential (kcal/mol) for CO2 at 298K, 1 bar

print "GCMC parameters:"
print "Temperature: ${T} K"
print "Pressure: ${P} bar"
print "Chemical potential: ${mu} kcal/mol"

# Temperature control for all atoms except constrained Cu
group           mobile_group subtract all cu_core_group
group           CO2  type 3 4

fix             rigid_CO2 CO2 rigid/small molecule  mol co2mol 
fix_modify      rigid_CO2 dynamic/dof yes

group           CO2_in_shell dynamic CO2 region gap_region every 1
variable        Cu_near_radius equal ${Cu_radius} + 3
region          near_cu sphere ${center} ${center} ${center} ${Cu_near_radius} side in
group           CO2_near_Cu  dynamic CO2 region near_cu every 1
variable        nCO2 equal "count(CO2)/3"
variable        nCO2_in_shell equal "count(CO2_in_shell)/3"
variable        nCO2_near_surface equal "count(CO2_near_Cu)/3"

group           c_shell_group type 2
fix             constrain_cu cu_core_group setforce 0.0 0.0 0.0
fix             constrain_c_shell c_shell_group setforce 0.0 0.0 0.0
# Fix for GCMC insertion/deletion of CO2 molecules
fix             gcmc_fix CO2 gcmc 100 100 0 0 12345 ${T} ${mu} 1.5 &
                mol co2mol &
                rigid rigid_CO2 &
                pressure ${P} &
                group CO2 &
                full_energy 

# ========== Thermostat and Dynamics ==========
compute mdtemp all temp
compute_modify mdtemp dynamic/dof yes
fix             nvt all nvt temp ${T} ${T} 100.0
fix_modify      nvt temp mdtemp


variable        trans_attempts equal f_gcmc_fix[1]
variable        trans_successes equal f_gcmc_fix[2]
variable        ins_attempts equal f_gcmc_fix[3]
variable        ins_successes equal f_gcmc_fix[4]
variable        del_attempts equal f_gcmc_fix[5]
variable        del_successes equal f_gcmc_fix[6]
variable        rot_attempts equal f_gcmc_fix[7]
variable        rot_successes equal f_gcmc_fix[8]

# ========== Output Settings ==========
# Thermodynamic output
thermo          10
compute_modify  thermo_temp dynamic/dof yes
thermo_style    custom step cpu cpuremain temp etotal pe ke  &
                v_nCO2  v_nCO2_in_shell v_nCO2_near_surface &
                v_trans_attempts v_trans_successes &
                v_ins_attempts v_ins_successes &
                v_del_attempts v_del_successes &
                v_rot_attempts v_rot_successes 
thermo_modify   lost warn flush yes
# f_gcmc_fix indices:
# [1] = number of accepted insertions
# [2] = number of accepted deletions
# [3] = number of attempted insertions
# [4] = number of attempted deletions

# Trajectory output
variable dist_to_center atom sqrt((x-${center})^2+(y-${center})^2+(z-${center})^2)
dump            traj all custom 500 trajectory_Cu_${Cu_radius}_lj.lammpstrj id type x y z q v_dist_to_center
dump_modify     traj sort id append yes

# Restart files
restart         1000 restart_${Cu_radius}.*.lammps


# ========== Production Run ==========
print "=== Production GCMC/MD (20 ps) ==="
# Each cycle: GCMC attempts + MD relaxation
run             200000  upto    # GCMC attempts


# ========== Final Analysis and Output ==========
print "=== Simulation Complete ==="

# Calculate adsorption statistics
variable        volume_A equal "vol"
variable        volume_nm3 equal "vol/1000.0"
variable        adsorption_density equal "${nCO2}/${volume_nm3}"
variable        adsorption_mmol_g equal "${adsorption_density}*1.66054"

# Acceptance rates
# Calculate acceptance rates
variable        trans_rate equal ${trans_successes}/${trans_attempts}
variable        ins_rate equal ${ins_successes}/${ins_attempts}
variable        del_rate equal ${del_successes}/${del_attempts}
variable        rot_rate equal ${rot_successes}/${rot_attempts}

print "========================================"
print "FINAL RESULTS - CO2 Adsorption at ${P} bar, ${T} K"
print "========================================"
print "System volume: ${volume_A} Å³ (${volume_nm3} nm³)"
print "Total CO2 molecules: ${nCO2}"
print "Translation Moves:"
print "  Attempts: ${trans_attempts}"
print "  Successes: ${trans_successes}"
print "  Acceptance rate: ${trans_rate:.4f}"
print ""
print "Insertion Moves:"
print "  Attempts: ${ins_attempts}"
print "  Successes: ${ins_successes}"
print "  Acceptance rate: ${ins_rate:.4f}"
print ""
print "Deletion Moves:"
print "  Attempts: ${del_attempts}"
print "  Successes: ${del_successes}"
print "  Acceptance rate: ${del_rate:.4f}"
print ""
print "Rotation Moves:"
print "  Attempts: ${rot_attempts}"
print "  Successes: ${rot_successes}"
print "  Acceptance rate: ${rot_rate:.4f}"
print ""
print "CO2 Adsorption Results:"
print "  Net CO2 insertions (insertions - deletions): ${net_CO2_insertions}"
print "  Net CO2 molecules (atoms/3): ${net_CO2_molecules}"
print "  Current CO2 molecules in system: ${nCO2}"
print "  Adsorption density: ${adsorption_density:.4f} molecules/nm³"
print "  Adsorption capacity: ${adsorption_mmol_g:.4f} mmol/g"
print "========================================"

# Save comprehensive statistics to file
shell           echo "CO2 Adsorption in Cu_cav@C at 10 bar, 298 K" > gcmc_statistics.txt
shell           echo "==============================================" >> gcmc_statistics.txt
shell           echo "Simulation parameters:" >> gcmc_statistics.txt
shell           echo "  Temperature: ${T} K" >> gcmc_statistics.txt
shell           echo "  Pressure: ${P} bar" >> gcmc_statistics.txt
shell           echo "  Chemical potential: ${mu} kcal/mol" >> gcmc_statistics.txt
shell           echo "  Timestep: 0.1 fs" >> gcmc_statistics.txt
shell           echo "  Total simulation time: 55 ps (5 equil + 50 prod)" >> gcmc_statistics.txt
shell           echo "" >> gcmc_statistics.txt
shell           echo "GCMC Move Statistics:" >> gcmc_statistics.txt
shell           echo "  Translation attempts: ${trans_attempts}" >> gcmc_statistics.txt
shell           echo "  Translation successes: ${trans_successes}" >> gcmc_statistics.txt
shell           echo "  Translation rate: ${trans_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Insertion attempts: ${ins_attempts}" >> gcmc_statistics.txt
shell           echo "  Insertion successes: ${ins_successes}" >> gcmc_statistics.txt
shell           echo "  Insertion rate: ${ins_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Deletion attempts: ${del_attempts}" >> gcmc_statistics.txt
shell           echo "  Deletion successes: ${del_successes}" >> gcmc_statistics.txt
shell           echo "  Deletion rate: ${del_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Rotation attempts: ${rot_attempts}" >> gcmc_statistics.txt
shell           echo "  Rotation successes: ${rot_successes}" >> gcmc_statistics.txt
shell           echo "  Rotation rate: ${rot_rate:.4f}" >> gcmc_statistics.txt
shell           echo "" >> gcmc_statistics.txt
shell           echo "Adsorption Results:" >> gcmc_statistics.txt
shell           echo "  Net CO2 insertions: ${net_CO2_insertions}" >> gcmc_statistics.txt
shell           echo "  Net CO2 molecules: ${net_CO2_molecules}" >> gcmc_statistics.txt
shell           echo "  Current CO2 in system: ${nCO2}" >> gcmc_statistics.txt
shell           echo "  Adsorption density: ${adsorption_density:.4f} molecules/nm³" >> gcmc_statistics.txt
shell           echo "  Adsorption capacity: ${adsorption_mmol_g:.4f} mmol/g" >> gcmc_statistics.txt

print "Detailed statistics saved to gcmc_statistics.txt"
print "All done!"

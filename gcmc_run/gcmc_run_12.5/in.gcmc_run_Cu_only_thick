# ========================================================
# LAMMPS Input Script for GCMC Simulation of CO2 Adsorption
# in Cu_cav@C Core-Shell Structure with ReaxFF Force Field
# ========================================================

# ========== Initialization ==========
units           real
atom_style      full
boundary        p p p
neighbor        2.0 bin
neigh_modify    delay 0 every 1 check yes 

variable        Cu_radius equal 12.5     # Angstrom (2.5 nm)
# ========== Read Structure ==========
read_data       Cu_Core_only_${Cu_radius}_thick.lammps extra/bond/types 1 extra/atom/types 2 extra/angle/types 1 &
                extra/dihedral/types 3 &
                extra/improper/types 3 &
                extra/special/per/atom 3 &
                extra/bond/per/atom 3 &
                extra/angle/per/atom 3 &
                extra/dihedral/per/atom 3 &
                extra/improper/per/atom 3 &

# ========== Atom Type Definitions ==========
# Type 1: Cu (from core)
# Type 2: C  (from carbon shell)
# Type 3: C  (from CO2 molecule)
# Type 4: O  (from CO2 molecule)

# Define CO2 molecule template
molecule        co2mol CO2.mol  toff 1 # Create this file with CO2 coordinates
# Set masses (g/mol)
mass            1 63.546     # Cu
mass            2 12.011     # C (shell)
mass            3 15.999     # O (CO2)


# ========== ReaxFF Force Field Setup ==========
# Load your ReaxFF force field file
pair_style      reaxff NULL
pair_coeff      * * jp046244d_si_002.reaxff Cu C O  # Check your ffield file for element order

# Charge equilibration (QEq) for ReaxFF
fix             qeq all qeq/reaxff 1 0.0 10.0 1.0e-6 reaxff maxiter 80000

# ========== Define Regions ==========
# Region for GCMC insertion (gap between Cu core and carbon shell)
variable        gap equal 82.2           # Angstrom (8.22 nm)
variable        outer_radius equal ${Cu_radius}+${gap}
variable        cu_core_outer equal ${Cu_radius}-1.5
variable        center equal lx/2

# Define spherical shell region for CO2 insertion
region          cu_core_outward     sphere ${center} ${center} ${center} ${cu_core_outer} side out
region          carbon_shell sphere ${center} ${center} ${center} ${outer_radius} side in
region          gap_region  intersect 2 cu_core_outward carbon_shell
variable        cell_length equal lx
region          cell  block 0.0 ${cell_length} 0.0 ${cell_length} 0.0 ${cell_length}
region          out_of_cu sphere ${center} ${center} ${center} ${cu_core_outer} side out
region          gcmc_region intersect 2 out_of_cu cell

# Region to constrain Cu core (optional, to prevent drift)
region          cu_core sphere ${center} ${center} ${center} ${Cu_radius} side in
group           cu_core_group region cu_core
#fix             constrain_cu cu_core_group setforce 0.0 0.0 0.0

thermo          100
thermo_style    custom step cpu cpuremain temp press density vol atoms etotal pe ke 
thermo_modify   lost warn flush yes
timestep        0.1 # 0.1 fs

# ========== Initial Energy Minimization ==========
print "=== Initial energy minimization ==="
min_style       cg
minimize        1.0e-4 1.0e-6 1000 10000
reset_timestep  0

# ========== GCMC Setup for CO2 Adsorption ==========


# GCMC parameters
variable        T equal 298.0     # K
variable        P equal 10.0          # bar
variable        kT equal 0.001987*${T} # kcal/mol
variable        mu0 equal -416.71462715         # μ at 1 bar, 298 K, kcal/mol
variable        mu  equal ${mu0}+${kT}*ln(${P})           # Chemical potential (kcal/mol) for CO2 at 298K, 1 bar

print "GCMC parameters:"
print "Temperature: ${T} K"
print "Pressure: ${P} bar"
print "Chemical potential: ${mu} kcal/mol"

# Temperature control for all atoms except constrained Cu
group           mobile_group subtract all cu_core_group
group           CO2  type 2 3
group           CO2_in_shell dynamic CO2 region gap_region every 1
variable        Cu_near_radius equal ${Cu_radius} + 3.5
region          near_cu sphere ${center} ${center} ${center} ${Cu_near_radius} side in
group           CO2_near_Cu  dynamic CO2 region near_cu every 1
variable        nCO2 equal "count(CO2)/3"
variable        nCO2_in_shell equal "count(CO2_in_shell)/3"
variable        nCO2_near_surface equal "count(CO2_near_Cu)/3"


# Fix for GCMC insertion/deletion of CO2 molecules
fix             gcmc_fix CO2 gcmc 100 100 100 0 12345 ${T} ${mu} 1.5 &
                mol co2mol &
                pressure ${P} &
                maxangle 45 &
                group CO2 &
                full_energy &
                mcmoves 20 40 40

# ========== Thermostat and Dynamics ==========
compute mdtemp all temp
compute_modify mdtemp dynamic/dof yes
fix             nvt all nvt temp ${T} ${T} 100.0
fix_modify      nvt temp mdtemp

variable        trans_attempts equal f_gcmc_fix[1]
variable        trans_successes equal f_gcmc_fix[2]
variable        ins_attempts equal f_gcmc_fix[3]
variable        ins_successes equal f_gcmc_fix[4]
variable        del_attempts equal f_gcmc_fix[5]
variable        del_successes equal f_gcmc_fix[6]
variable        rot_attempts equal f_gcmc_fix[7]
variable        rot_successes equal f_gcmc_fix[8]
# Calculate acceptance rates
variable        trans_rate equal ${trans_successes}/${trans_attempts}
variable        ins_rate equal ${ins_successes}/${ins_attempts}
variable        del_rate equal ${del_successes}/${del_attempts}
variable        rot_rate equal ${rot_successes}/${rot_attempts}
# ========== Output Settings ==========
# Thermodynamic output
thermo  100
compute_modify  thermo_temp dynamic/dof yes
thermo_style    custom step cpu cpuremain temp etotal pe ke  &
                v_nCO2  v_nCO2_in_shell v_nCO2_near_surface &
                v_trans_attempts v_trans_successes &
                v_ins_attempts v_ins_successes &
                v_del_attempts v_del_successes &
                v_rot_attempts v_rot_successes 
thermo_modify   lost warn flush yes
# f_gcmc_fix indices:
# [1] = number of accepted insertions
# [2] = number of accepted deletions
# [3] = number of attempted insertions
# [4] = number of attempted deletions

# Trajectory output
variable dist_to_center atom sqrt((x-${center})^2+(y-${center})^2+(z-${center})^2)
dump            traj all custom 500 trajectory_Cu_${Cu_radius}_thick.lammpstrj id type x y z q v_dist_to_center
dump_modify     traj sort id

# Restart files
restart         1000 restart_Cu_only_thick.*.lammps

# ========== Equilibration Phase ==========
print "=== Equilibration phase (5 ps) ==="
run             50000  # 5 ps

# ========== Production Run ==========
print "=== Production GCMC/MD (20 ps) ==="
# Each cycle: GCMC attempts + MD relaxation
run             200000      # GCMC attempts


# ========== Final Analysis and Output ==========
print "=== Simulation Complete ==="

# Calculate adsorption statistics
variable        volume_nm3 equal "vol/1000.0"
variable        adsorption_density equal "${nCO2}/${volume_nm3}"
variable        adsorption_mmol_g equal "${adsorption_density}*1.66054"

# Acceptance rates

print "========================================"
print "FINAL RESULTS - CO2 Adsorption at ${P} bar, ${T} K"
print "========================================"
print "System volume: ${vol} Å³ (${volume_nm3} nm³)"
print "Total CO2 molecules: ${nCO2}"
print "Translation Moves:"
print "  Attempts: ${trans_attempts}"
print "  Successes: ${trans_successes}"
print "  Acceptance rate: ${trans_rate:.4f}"
print ""
print "Insertion Moves:"
print "  Attempts: ${ins_attempts}"
print "  Successes: ${ins_successes}"
print "  Acceptance rate: ${ins_rate:.4f}"
print ""
print "Deletion Moves:"
print "  Attempts: ${del_attempts}"
print "  Successes: ${del_successes}"
print "  Acceptance rate: ${del_rate:.4f}"
print ""
print "Rotation Moves:"
print "  Attempts: ${rot_attempts}"
print "  Successes: ${rot_successes}"
print "  Acceptance rate: ${rot_rate:.4f}"
print ""
print "CO2 Adsorption Results:"
print "  Net CO2 insertions (insertions - deletions): ${net_CO2_insertions}"
print "  Net CO2 molecules (atoms/3): ${net_CO2_molecules}"
print "  Current CO2 molecules in system: ${nCO2}"
print "  Adsorption density: ${adsorption_density:.4f} molecules/nm³"
print "  Adsorption capacity: ${adsorption_mmol_g:.4f} mmol/g"
print "========================================"

# Save comprehensive statistics to file
shell           echo "CO2 Adsorption in Cu_cav@C at 10 bar, 298 K" > gcmc_statistics.txt
shell           echo "==============================================" >> gcmc_statistics.txt
shell           echo "Simulation parameters:" >> gcmc_statistics.txt
shell           echo "  Temperature: ${T} K" >> gcmc_statistics.txt
shell           echo "  Pressure: ${P} bar" >> gcmc_statistics.txt
shell           echo "  Chemical potential: ${mu} kcal/mol" >> gcmc_statistics.txt
shell           echo "  Timestep: 0.1 fs" >> gcmc_statistics.txt
shell           echo "  Total simulation time: 55 ps (5 equil + 50 prod)" >> gcmc_statistics.txt
shell           echo "" >> gcmc_statistics.txt
shell           echo "GCMC Move Statistics:" >> gcmc_statistics.txt
shell           echo "  Translation attempts: ${trans_attempts}" >> gcmc_statistics.txt
shell           echo "  Translation successes: ${trans_successes}" >> gcmc_statistics.txt
shell           echo "  Translation rate: ${trans_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Insertion attempts: ${ins_attempts}" >> gcmc_statistics.txt
shell           echo "  Insertion successes: ${ins_successes}" >> gcmc_statistics.txt
shell           echo "  Insertion rate: ${ins_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Deletion attempts: ${del_attempts}" >> gcmc_statistics.txt
shell           echo "  Deletion successes: ${del_successes}" >> gcmc_statistics.txt
shell           echo "  Deletion rate: ${del_rate:.4f}" >> gcmc_statistics.txt
shell           echo "  Rotation attempts: ${rot_attempts}" >> gcmc_statistics.txt
shell           echo "  Rotation successes: ${rot_successes}" >> gcmc_statistics.txt
shell           echo "  Rotation rate: ${rot_rate:.4f}" >> gcmc_statistics.txt
shell           echo "" >> gcmc_statistics.txt
shell           echo "Adsorption Results:" >> gcmc_statistics.txt
shell           echo "  Net CO2 insertions: ${net_CO2_insertions}" >> gcmc_statistics.txt
shell           echo "  Net CO2 molecules: ${net_CO2_molecules}" >> gcmc_statistics.txt
shell           echo "  Current CO2 in system: ${nCO2}" >> gcmc_statistics.txt
shell           echo "  Adsorption density: ${adsorption_density:.4f} molecules/nm³" >> gcmc_statistics.txt
shell           echo "  Adsorption capacity: ${adsorption_mmol_g:.4f} mmol/g" >> gcmc_statistics.txt

print "Detailed statistics saved to gcmc_statistics.txt"
print "All done!"
